<!-- admin-analytics/index.html (host privately) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VulnShop Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b0c10;color:#e6e6e6}
    header{padding:12px 16px;background:#15171c;border-bottom:1px solid #20222a;font-weight:700}
    main{max-width:1000px;margin:16px auto;padding:0 16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:#121318;border:1px solid #20222a;border-radius:10px;padding:12px;flex:1;min-width:220px}
    table{width:100%;border-collapse:collapse}
    td,th{border-bottom:1px solid #20222a;padding:6px 8px;font-size:13px}
    input,button{padding:8px;border-radius:8px;border:1px solid #2a2e39;background:#0e0f14;color:#e6e6e6}
  </style>
</head>
<body>
  <header>VulnShop Analytics</header>
  <main>
    <div class="row">
      <div class="card"><div>Total</div><div id="stat-total" style="font-size:22px">-</div></div>
      <div class="card"><div>Admin Logins</div><div id="stat-admin" style="font-size:22px">-</div></div>
      <div class="card"><div>Uploads</div><div id="stat-upload" style="font-size:22px">-</div></div>
    </div>
    <div style="margin:12px 0">
      <label>Worker Base URL <input id="base" size="40" placeholder="https://vulnlog.workers.dev"></label>
      <label>Admin User <input id="user" size="12" value="admin"></label>
      <label>Password <input id="pass" type="password" size="12"></label>
      <button id="load">Load</button>
    </div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Recent Events</strong>
        <button id="more">Load more</button>
      </div>
      <table>
        <thead><tr><th>Time</th><th>Type</th><th>IP</th><th>URL</th><th>UA</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>
  <script>
    let cursor = undefined;
    function authHeader(u, p) {
      return "Basic " + btoa(u + ":" + p);
    }
    async function fetchJson(url, user, pass) {
      const res = await fetch(url, { headers: { Authorization: authHeader(user, pass) } });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }
    async function loadStats(base, user, pass) {
      const data = await fetchJson(`${base}/stats`, user, pass);
      document.getElementById("stat-total").textContent = data.counters["total"] || 0;
      document.getElementById("stat-admin").textContent = data.counters["type:admin_login"] || 0;
      document.getElementById("stat-upload").textContent = data.counters["type:file_upload"] || 0;
    }
    function row(e) {
      const tr = document.createElement("tr");
      const time = new Date(e.ts).toISOString().replace("T"," ").replace("Z","");
      tr.innerHTML = `<td>${time}</td><td>${e.event_type}</td><td>${e.client_ip}</td><td>${e.url}</td><td>${(e.ua||"").slice(0,60)}</td>`;
      return tr;
    }
    async function loadEvents(base, user, pass) {
      const qs = new URLSearchParams(); if (cursor) qs.set("cursor", cursor); qs.set("limit","50");
      const data = await fetchJson(`${base}/events?` + qs.toString(), user, pass);
      cursor = data.cursor;
      const tb = document.getElementById("tbody");
      for (const e of data.items) tb.prepend(row(e));
    }
    document.getElementById("load").addEventListener("click", async () => {
      cursor = undefined;
      document.getElementById("tbody").innerHTML = "";
      const base = document.getElementById("base").value.trim();
      const user = document.getElementById("user").value.trim();
      const pass = document.getElementById("pass").value;
      await loadStats(base, user, pass);
      await loadEvents(base, user, pass);
    });
    document.getElementById("more").addEventListener("click", async () => {
      const base = document.getElementById("base").value.trim();
      const user = document.getElementById("user").value.trim();
      const pass = document.getElementById("pass").value;
      await loadEvents(base, user, pass);
    });
  </script>
</body>
</html>
