<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>API Testing â€” VulnShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">VulnShop</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="admin/index.html">Admin</a>
      <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">ðŸŒ™</button>
    </nav>
  </header>

  <main class="container">
    <h1>API Testing Interface</h1>
    <p class="muted">Test various API endpoints with different vulnerabilities.</p>

    <div class="card mt">
      <h2>1. Insecure Direct Object Reference (IDOR)</h2>
      <p>Access user data by ID:</p>
      <form id="user-form">
        <input type="number" name="user_id" placeholder="User ID" value="1" required>
        <button type="submit">Get User</button>
      </form>
      <pre id="user-output" class="mt"></pre>
      <script>
        document.getElementById('user-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const userId = e.target.user_id.value;
          const output = document.getElementById('user-output');
          
          // VULNERABLE: IDOR - no authorization check
          try {
            const response = await fetch('/api/users/' + userId);
            const data = await response.json();
            output.textContent = JSON.stringify(data, null, 2);
          } catch (err) {
            output.textContent = JSON.stringify({
              id: userId,
              email: 'user' + userId + '@example.com',
              password_hash: '$2y$10$abcdefghijklmnopqrstuvwxyz1234567890',
              credit_card: '4111-1111-1111-1111',
              ssn: '123-45-6789',
              address: '123 Main St, City, State 12345'
            }, null, 2);
          }
        });
      </script>
    </div>

    <div class="card mt">
      <h2>2. Mass Assignment</h2>
      <p>Update user profile:</p>
      <form id="update-form">
        <input type="text" name="email" placeholder="Email" required>
        <input type="text" name="role" placeholder="Role (try: admin)" value="user">
        <input type="text" name="is_admin" placeholder="Is Admin (try: true)" value="false">
        <button type="submit">Update Profile</button>
      </form>
      <pre id="update-output" class="mt"></pre>
      <script>
        document.getElementById('update-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData);
          const output = document.getElementById('update-output');
          
          // VULNERABLE: Mass Assignment - accepts all fields
          try {
            const response = await fetch('/api/users/me', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
            const result = await response.json();
            output.textContent = JSON.stringify(result, null, 2);
          } catch (err) {
            output.textContent = JSON.stringify({
              success: true,
              user: data,
              message: 'Profile updated. Role escalation possible if is_admin=true is accepted.'
            }, null, 2);
          }
        });
      </script>
    </div>

    <div class="card mt">
      <h2>3. NoSQL Injection</h2>
      <p>Login with MongoDB query injection:</p>
      <form id="nosql-form">
        <input type="text" name="username" placeholder="Username" required>
        <input type="text" name="password" placeholder="Password" required>
        <button type="submit">Login</button>
      </form>
      <pre id="nosql-output" class="mt"></pre>
      <script>
        document.getElementById('nosql-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData);
          const output = document.getElementById('nosql-output');
          
          // VULNERABLE: NoSQL Injection
          try {
            const response = await fetch('/api/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
            const result = await response.json();
            output.textContent = JSON.stringify(result, null, 2);
          } catch (err) {
            // Simulate NoSQL injection
            if (data.password.includes('$ne') || data.password.includes('$gt') || data.username.includes('$regex')) {
              output.textContent = JSON.stringify({
                success: true,
                token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiYWRtaW4ifQ',
                message: 'NoSQL injection successful! Query bypassed authentication.'
              }, null, 2);
            } else {
              output.textContent = JSON.stringify({
                success: false,
                message: 'Invalid credentials'
              }, null, 2);
            }
          }
        });
      </script>
    </div>

    <div class="card mt">
      <h2>4. JWT Vulnerabilities</h2>
      <p>Test JWT token manipulation:</p>
      <form id="jwt-form">
        <textarea name="token" placeholder="Paste JWT token" rows="3" style="width: 100%; font-family: monospace;"></textarea>
        <button type="submit">Verify Token</button>
      </form>
      <pre id="jwt-output" class="mt"></pre>
      <script>
        document.getElementById('jwt-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const token = e.target.token.value;
          const output = document.getElementById('jwt-output');
          
          // VULNERABLE: JWT with weak secret or algorithm confusion
          try {
            const parts = token.split('.');
            if (parts.length === 3) {
              const header = JSON.parse(atob(parts[0]));
              const payload = JSON.parse(atob(parts[1]));
              
              output.textContent = JSON.stringify({
                header: header,
                payload: payload,
                vulnerabilities: [
                  header.alg === 'none' ? 'Algorithm set to "none" - signature not verified' : null,
                  header.alg === 'HS256' ? 'Weak algorithm' : null,
                  'Payload can be modified if secret is weak or algorithm is vulnerable'
                ].filter(Boolean)
              }, null, 2);
            }
          } catch (err) {
            output.textContent = 'Invalid JWT format';
          }
        });
      </script>
    </div>

    <div class="card mt">
      <h2>API Vulnerability Payloads</h2>
      <h3>NoSQL Injection:</h3>
      <ul>
        <li>Username: <code>admin</code>, Password: <code>{"$ne": null}</code></li>
        <li>Username: <code>{"$regex": ".*"}</code>, Password: <code>{"$ne": ""}</code></li>
        <li>Username: <code>admin</code>, Password: <code>{"$gt": ""}</code></li>
      </ul>
      
      <h3>JWT Attacks:</h3>
      <ul>
        <li>Change algorithm to <code>none</code></li>
        <li>Use <code>HS256</code> with public key (algorithm confusion)</li>
        <li>Brute force weak secrets</li>
        <li>Modify payload and re-sign with weak secret</li>
      </ul>
    </div>
  </main>

  <script src="assets/js/theme.js"></script>
  <script src="assets/js/logger.js"></script>
  <script src="assets/js/app.js"></script>
</body>
</html>
